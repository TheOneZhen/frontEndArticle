# 内容嵌入

HTML有以下嵌入元素：

- `<iframe>`：将整个HTML页面放置到当前页面中
- `<embed>`：
- `<object>`：
- `<audio>`
- `<canvas>`
- `<img>`
- `<math>`
- `<svg>`
- `<video>`

# [iframe](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe)

iframe能够将一个HTML页面直接嵌入到另一个HTML页面中，并且每个iframe页面都拥有完整的Document。使用[`window.frames`](https://developer.mozilla.org/en-US/docs/Web/API/Window/frames)，可以查看HTML包含的iframe。

`HTMLIFrameElement`是iframe元素的接口，提供了一些特殊属性和方法：

- `HTMLIFrameElement.contentDocument`(只读)：如果子iframe和parent[同源](https://developer.mozilla.org/en-US/docs/Glossary/Same-origin_policy)，返回iframe的`document`对象，否则返回`null`；
- `HTMLIFrameElement.contentWindow`(只读)：返回子iframe的window对象

## sandbox

sandbox是iframe的重要特性，默认的sandbox限制条件严格，基本上能防的都防了，常用值包括：

- allow-same-origin
    
    允许子iframe使用同源策略。默认情况下，"sandbox"会为iframe强制实施非同源策略，导致主页面无法访问iframe页面中的文档。

- allow-top-navigation：允许iframe中修改[`window.top`](https://developer.mozilla.org/en-US/docs/Web/API/Window/top)`.location`，这里的`window.top`指向最顶层的window
- allow-top-navigation-by-user-activation: 允许iframe在经过用户允许后修改`window.top.location`
- allow-forms：允许iframe中提交表单
- allow-scripts：允许iframe中运行脚本
- allow-modals：允许iframe打开modal窗口

> 更多属性介绍可以查看[MDN-SCP: sandbox](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/sandbox)。

## 通信

主页面和iframe页面的通信与跨窗口通信无异，所以可以使用[`postMessage`](https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage)，上面介绍了`HTMLIFrameElement`接口，也可以作为通信方式的一种：

- `HTMLIFrameElement`：获取iframe界面的`contentWindow`，可以访问属性和方法，和window一样，且不受SOP限制；

- `window.postMessage`：

    可以安全的实现跨源通信，不受SOP限制。假设现在有一个主页面，主页面下有俩个iframe页面：
    ```html
    // template
    <main>
        <iframe name="iframe1" src="https://iframe1" />
        <iframe name="iframe2" src="https://iframe2" />
    </main>
    ```
    现在需要通过主页面向俩个iframe页面发消息：
    ```js
    data = {}
    window.postMessage(data, "https://iframe1")
    ```
    然后在iframe1页面可以通过监听`message`事件获取数据：
    ```js
    // iframe
    window.frames.iframe1.addEventListener("message", (event) => {
      console.log(event) // { data: "传递过来的数据", origin: "发送消息窗口的URL", source: "发送消息窗口window对象的引用" }
    })
    ```
    事件格式为[MessageEvent](https://developer.mozilla.org/en-US/docs/Web/API/MessageEvent)，和Web Worker postMessage事件一致。

## iframe安全问题

点击劫持（Click Jacking）是iframe常见安全问题。攻击者会在目标网站上套个壳，然后劫持用户交互信息：

<div style="height: 20px; width: 20%; background: black">origin site input</div>
<div style="height: 20px; width: 20%; margin-top: -18px">hacker</div>

这个时候你可能是在攻击人员的输入框中输入用户密码，然后你的信息被窃取。可以通过配置CSP指令，禁止在frame中显示你的网站：

服务端header配置X-Frame-Options，值包括：

- DENY：始终进制在frame中显示此页面
- SAMEORIGIN：只在同源页面中显示
- ALLOW-FROM domain：只在给定的域中显示



- iframe注入：
  
    跨站脚本（XSS，Cross Site Scripting）攻击的一种，如果你的网站支持用户修改网站HTML，可能会被有心之人注入不怀好意的`<iframe>`。或者你的网站通过GET获取一段代码执行，像下面这样：
    
    ```js
    // url: http://site.com/?code=%3Ciframe%20src='hacker'%3E
    // 解析这个链接获取code参数的文本，将这个脚本写入文档
    code = decodeURL(url) // http://site.com/?code=<iframe src='hacker'>
    document.write(code)
    ```
    
    然后你的文档中莫名多出一个广告，如果是更恶意的代码，可能会获取网站**cookie**然后一系列操作，带来严重后果。

- 
- XFS


### HTTPS

HTTPS是HTTP的加密版本，作用：

- 尽可能避免远程内容在传输过程中被修改
- 防止嵌入式内容访问

### sandbox

同时添加**allow-scripts**和**allow-same-origin**，嵌入式内容可以绕过阻止站点执行脚本的同源策略（SOP，Same Origin Policy），并使用JS完全关闭**sandbox**。

### 配置CSP指令

内容安全策略（CSP，Content Security Policy），提供一些HTTP头，

X-Frame-Options：服务器设置不允许被嵌入到其他页面

# iframe

当iframe与parent同源时，

## 通信

### HTMLIFrameElement


可以借助上述的属性或方法，将安全的信息抛给parent。

contentDocument存在一个陷阱，iframe加载时会立即生成一个document对象，但是这个document对象不是`contentDocument`：
```html
...
<iframe src='' id='iframe' />
...
<script>
  let document = iframe.contentDocument
  iframe.onload = function () {
    console.log('is same: ', document === iframe.contentDocument) // is same: false
  }
</script>

```
## 框架介绍
- QianKun
- microApp
  - 为什么vite项目作为子应用，在microApp搭建过程中，沙箱被取消
- signal spa
- 无界


# 引用

1. https://developer.mozilla.org/zh-CN/docs/Learn/HTML/Multimedia_and_embedding/Other_embedding_technologies